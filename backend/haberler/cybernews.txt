from django.core.management.base import BaseCommand
from haberler.models import Bulletin
from .cybernews_service import CyberNews  # Make sure this import points to the correct location of CyberNews


from datetime import datetime

class Command(BaseCommand):
    help = 'The Hacker News sitesinden haberleri çeker ve Bulletin tablosuna kaydeder'

    def handle(self):
        cn = CyberNews()
        news_list = cn.get_news()

        self.stdout.write(f"{len(news_list)} haber çekildi.")

        for item in news_list:
            title = item.get('title') or "Başlıksız"
            link = item.get('link') or ""
            content = item.get('summary') or ""
            image_url = item.get('image_url') or ""
            published_at = item.get('published_at')

            if not published_at:
                published_at = datetime.now()

            if link and not Bulletin.objects.filter(link=link).exists():
                Bulletin.objects.create(
                    title=title,
                    content=content + f"\n\nKaynak: {link}",
                    link=link,
                    published_at=published_at,
                    image_url=image_url
                )
                self.stdout.write(self.style.SUCCESS(f"✓ Eklendi: {title}"))
            else:
                self.stdout.write(f"- Zaten var veya link yok: {title}")
